name: PHP Backend CI

on:
    push:
        branches: ["backend"]
    pull_request:
        branches: ["desarrollo"]

jobs:
    build:
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: control_asistencia
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -h localhost"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: "8.3"
                  extensions: mysqli
                  coverage: none

            - name: Check PHP syntax (lint)
              run: |
                  echo "Verificando sintaxis de los archivos PHP..."
                  find . -type f -name "*.php" -print0 | xargs -0 -n1 php -l

            - name: Test database connection
              env:
                  DB_HOST: 127.0.0.1
                  DB_USERNAME: root
                  DB_PASSWORD: root
                  DB_NAME: control_asistencia
              run: |
                  echo "<?php
                  \$conexion = new mysqli(getenv('DB_HOST'), getenv('DB_USERNAME'), getenv('DB_PASSWORD'), getenv('DB_NAME'));
                  if (\$conexion->connect_error) {
                    echo '❌ Error de conexión: ' . \$conexion->connect_error;
                    exit(1);
                  }
                  echo '✅ Conexión a MySQL exitosa';
                  ?>" > test_connection.php

                  php test_connection.php
